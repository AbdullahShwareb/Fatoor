<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ÙÙˆØ§ØªÙŠØ± Ù…Ø­Ù„Ø§Øª Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨</title>
  <style>
    body {
      font-family: "Tahoma","Arial","Noto Naskh Arabic",sans-serif;
      margin:20px; direction:rtl; background:#f5f7fb;
    }
    h1 {text-align:center; margin-bottom:15px;}
    table {width:100%; border-collapse:collapse; margin-top:20px; background:#fff;}
    th,td {
      border:1px solid #ddd;
      padding:8px;
      text-align:center;
      vertical-align:middle;
    }
    thead th {
      background:#e7efff;
      font-weight:bold;
    }
    tbody tr:nth-child(odd){background:#f9f9f9;}
    tfoot td {font-weight:bold; background:#eef4ff;}
    input {
      width:100%;
      border:none;
      padding:6px;
      text-align:center;
      background:transparent;
      outline:none;
    }
    td.name-cell input {
      text-align:right;
      white-space:normal;
      word-break:break-word;
    }
    .total-input {background:#f3f4f6;}
    .actions {
      margin:15px 0;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }
    button {
      padding:8px 14px;
      border-radius:6px;
      border:1px solid #0d6efd;
      background:#0d6efd;
      color:#fff;
      cursor:pointer;
    }
    button.outline {
      background:#fff;
      color:#0d6efd;
    }
    .del-btn {
      background:#dc3545;
      border-color:#dc3545;
    }
    .clear-btn {
      background:#6c757d;
      border-color:#6c757d;
    }
    @media print {
      .no-print{display:none;}
      input{border:none;}
      body{background:#fff;}
    }
  </style>
</head>
<body>
  <h1>ÙÙˆØ§ØªÙŠØ± Ù…Ø­Ù„Ø§Øª Ø£ÙŠÙ…Ù† Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨</h1>

  <div class="actions no-print">
    <button id="add">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
    <button id="clearAll" class="clear-btn">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
    <button class="outline" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:40px">#</th>
        <th class="name-cell">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th style="width:120px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
        <th style="width:140px">Ø§Ù„Ø³Ø¹Ø±/Ø­Ø¨Ø©</th>
        <th style="width:140px">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
        <th class="no-print" style="width:80px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
    <tfoot>
      <tr>
        <td colspan="4">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td>
        <td><input id="grand" class="total-input" readonly value="0.00"></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <script>
    // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
    const LS_KEY = 'fatoraRows_v1';

    // Ø¹Ù†Ø§ØµØ± DOM
    const bodyEl = document.getElementById('body');
    const grandEl = document.getElementById('grand');
    const addBtn = document.getElementById('add');
    const clearBtn = document.getElementById('clearAll');

    // Ø£Ø¯ÙˆØ§Øª Ø±Ù‚Ù…ÙŠØ©
    function fmt(n){return (n||0).toFixed(2);}
    function num(v){const n=parseFloat(v);return isNaN(n)?0:n;}

    // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø¥Ù„Ù‰ Local Storage
    function saveData(){
      const rows=[];
      bodyEl.querySelectorAll('tr').forEach(tr=>{
        rows.push({
          name: tr.querySelector('.name')?.value || '',
          qty: tr.querySelector('.qty')?.value || '0',
          price: tr.querySelector('.price')?.value || '0'
        });
      });
      localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Local Storage
    function loadData(){
      const data=JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if(Array.isArray(data) && data.length){
        data.forEach(r=>addRow(r.name, r.qty, r.price));
      }
      // Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù†Ø¨Ø¯Ø£ Ø¨ØµÙÙ‘ÙŠÙ†
      if(bodyEl.querySelectorAll('tr').length===0){
        addRow(); addRow();
      }
      calc();
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    function calc(){
      let g=0;
      bodyEl.querySelectorAll('tr').forEach(tr=>{
        const q=num(tr.querySelector('.qty').value);
        const p=num(tr.querySelector('.price').value);
        const total=q*p;
        tr.querySelector('.total').value=fmt(total);
        g+=total;
      });
      grandEl.value=fmt(g);
      // Ø§Ø­ÙØ¸ ÙÙˆØ±Ù‹Ø§ Ø¨Ø¹Ø¯ ÙƒÙ„ Ø­Ø³Ø§Ø¨
      saveData();
    }

    // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯
    function addRow(name="", qty=1, price=0){
      const i = bodyEl.querySelectorAll('tr').length+1;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="index">${i}</td>
        <td class="name-cell"><input class="name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" value="${name}"></td>
        <td><input type="number" class="qty" min="0" step="1" value="${qty}"></td>
        <td><input type="number" class="price" min="0" step="0.01" value="${price}"></td>
        <td><input class="total total-input" readonly value="0.00"></td>
        <td class="no-print"><button class="del-btn" title="Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±">ğŸ—‘ï¸</button></td>
      `;
      bodyEl.appendChild(tr);

      // Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      tr.querySelector('.qty').addEventListener('input', calc);
      tr.querySelector('.price').addEventListener('input', calc);
      tr.querySelector('.name').addEventListener('input', saveData);
      tr.querySelector('.del-btn').addEventListener('click', ()=>{
        tr.remove();
        renumber();
        calc();
      });

      calc();
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
    function renumber(){
      bodyEl.querySelectorAll('tr').forEach((tr,idx)=>{
        const cell = tr.querySelector('.index');
        if(cell) cell.textContent = idx+1;
      });
    }

    // Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„: ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ùˆ Local Storage Ø«Ù… Ø¥Ù†Ø´Ø§Ø¡ ØµÙÙ‘ÙŠÙ† ÙØ§Ø±ØºÙŠÙ†
    function clearAll(){
      if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ØŸ Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
      localStorage.removeItem(LS_KEY);
      bodyEl.innerHTML='';
      grandEl.value='0.00';
      addRow(); addRow();
      // Ø§Ù„Ø­ÙØ¸ ÙŠØªÙ… Ø¹Ø¨Ø± calc Ø¯Ø§Ø®Ù„ addRow
    }

    // Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    addBtn.addEventListener('click', ()=>addRow());
    clearBtn.addEventListener('click', clearAll);

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø¯Ø¦ÙŠ
    loadData();

    // ØªØ­Ø³ÙŠÙ† ØµØºÙŠØ±: Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±/Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¶ÙŠÙ ØµÙÙ‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§
    document.addEventListener('keydown', (e)=>{
      const isInEditable = e.target.classList.contains('name') ||
                           e.target.classList.contains('qty')  ||
                           e.target.classList.contains('price');
      if(isInEditable && e.key==='Enter'){
        e.preventDefault();
        addRow();
        // ØªØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const last = bodyEl.lastElementChild?.querySelector('.name');
        if(last) last.focus();
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>فواتير محلات أيمن أبو الشوارب</title>
  <style>
    body {
      font-family: "Tahoma","Arial","Noto Naskh Arabic",sans-serif;
      margin:20px; direction:rtl; background:#f5f7fb;
    }
    h1 {text-align:center; margin-bottom:15px;}
    table {width:100%; border-collapse:collapse; margin-top:20px; background:#fff;}
    th,td {
      border:1px solid #ddd;
      padding:8px;
      text-align:center;
      vertical-align:middle;
    }
    thead th {
      background:#e7efff;
      font-weight:bold;
    }
    tbody tr:nth-child(odd){background:#f9f9f9;}
    tfoot td {font-weight:bold; background:#eef4ff;}
    input {
      width:100%;
      border:none;
      padding:6px;
      text-align:center;
      background:transparent;
      outline:none;
    }
    td.name-cell input {
      text-align:right;
      white-space:normal;
      word-break:break-word;
    }
    .total-input {background:#f3f4f6;}
    .actions {
      margin:15px 0;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }
    button {
      padding:8px 14px;
      border-radius:6px;
      border:1px solid #0d6efd;
      background:#0d6efd;
      color:#fff;
      cursor:pointer;
    }
    button.outline {
      background:#fff;
      color:#0d6efd;
    }
    .del-btn {
      background:#dc3545;
      border-color:#dc3545;
    }
    .clear-btn {
      background:#6c757d;
      border-color:#6c757d;
    }
    @media print {
      .no-print{display:none;}
      input{border:none;}
      body{background:#fff;}
    }
  </style>
</head>
<body>
  <h1>فواتير محلات أيمن أبو الشوارب</h1>

  <div class="actions no-print">
    <button id="add">➕ إضافة سطر</button>
    <button id="clearAll" class="clear-btn">🧹 مسح الكل</button>
    <button class="outline" onclick="window.print()">🖨️ طباعة</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:40px">#</th>
        <th class="name-cell">اسم المنتج</th>
        <th style="width:120px">الكمية</th>
        <th style="width:140px">السعر/حبة</th>
        <th style="width:140px">المجموع</th>
        <th class="no-print" style="width:80px">إجراءات</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
    <tfoot>
      <tr>
        <td colspan="4">الإجمالي الكلي</td>
        <td><input id="grand" class="total-input" readonly value="0.00"></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <script>
    // مفاتيح التخزين
    const LS_KEY = 'fatoraRows_v1';

    // عناصر DOM
    const bodyEl = document.getElementById('body');
    const grandEl = document.getElementById('grand');
    const addBtn = document.getElementById('add');
    const clearBtn = document.getElementById('clearAll');

    // أدوات رقمية
    function fmt(n){return (n||0).toFixed(2);}
    function num(v){const n=parseFloat(v);return isNaN(n)?0:n;}

    // حفظ جميع الصفوف إلى Local Storage
    function saveData(){
      const rows=[];
      bodyEl.querySelectorAll('tr').forEach(tr=>{
        rows.push({
          name: tr.querySelector('.name')?.value || '',
          qty: tr.querySelector('.qty')?.value || '0',
          price: tr.querySelector('.price')?.value || '0'
        });
      });
      localStorage.setItem(LS_KEY, JSON.stringify(rows));
    }

    // تحميل البيانات من Local Storage
    function loadData(){
      const data=JSON.parse(localStorage.getItem(LS_KEY) || '[]');
      if(Array.isArray(data) && data.length){
        data.forEach(r=>addRow(r.name, r.qty, r.price));
      }
      // إن لم توجد بيانات، نبدأ بصفّين
      if(bodyEl.querySelectorAll('tr').length===0){
        addRow(); addRow();
      }
      calc();
    }

    // حساب الإجماليات
    function calc(){
      let g=0;
      bodyEl.querySelectorAll('tr').forEach(tr=>{
        const q=num(tr.querySelector('.qty').value);
        const p=num(tr.querySelector('.price').value);
        const total=q*p;
        tr.querySelector('.total').value=fmt(total);
        g+=total;
      });
      grandEl.value=fmt(g);
      // احفظ فورًا بعد كل حساب
      saveData();
    }

    // إضافة صف جديد
    function addRow(name="", qty=1, price=0){
      const i = bodyEl.querySelectorAll('tr').length+1;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="index">${i}</td>
        <td class="name-cell"><input class="name" placeholder="اكتب اسم المنتج" value="${name}"></td>
        <td><input type="number" class="qty" min="0" step="1" value="${qty}"></td>
        <td><input type="number" class="price" min="0" step="0.01" value="${price}"></td>
        <td><input class="total total-input" readonly value="0.00"></td>
        <td class="no-print"><button class="del-btn" title="حذف هذا السطر">🗑️</button></td>
      `;
      bodyEl.appendChild(tr);

      // مستمعات الأحداث
      tr.querySelector('.qty').addEventListener('input', calc);
      tr.querySelector('.price').addEventListener('input', calc);
      tr.querySelector('.name').addEventListener('input', saveData);
      tr.querySelector('.del-btn').addEventListener('click', ()=>{
        tr.remove();
        renumber();
        calc();
      });

      calc();
    }

    // إعادة ترقيم العمود الأول بعد الحذف
    function renumber(){
      bodyEl.querySelectorAll('tr').forEach((tr,idx)=>{
        const cell = tr.querySelector('.index');
        if(cell) cell.textContent = idx+1;
      });
    }

    // مسح الكل: تفريغ الجدول و Local Storage ثم إنشاء صفّين فارغين
    function clearAll(){
      if(!confirm('هل أنت متأكد من مسح جميع البنود؟ لن يمكن التراجع.')) return;
      localStorage.removeItem(LS_KEY);
      bodyEl.innerHTML='';
      grandEl.value='0.00';
      addRow(); addRow();
      // الحفظ يتم عبر calc داخل addRow
    }

    // أزرار أعلى الصفحة
    addBtn.addEventListener('click', ()=>addRow());
    clearBtn.addEventListener('click', clearAll);

    // تحميل مبدئي
    loadData();

    // تحسين صغير: الضغط على Enter داخل السعر/الكمية يضيف صفًا جديدًا
    document.addEventListener('keydown', (e)=>{
      const isInEditable = e.target.classList.contains('name') ||
                           e.target.classList.contains('qty')  ||
                           e.target.classList.contains('price');
      if(isInEditable && e.key==='Enter'){
        e.preventDefault();
        addRow();
        // تركّز على اسم المنتج في الصف الجديد
        const last = bodyEl.lastElementChild?.querySelector('.name');
        if(last) last.focus();
      }
    });
  </script>
</body>
</html>
